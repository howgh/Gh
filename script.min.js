import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, collection, onSnapshot, setDoc, doc, query, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// setLogLevel('debug'); // KOMENTARI ATAU HAPUS INI SEBELUM OBFUSCATION

// --- 1. PENGAMBILAN VARIABEL GLOBAL (Versi Paling Aman) ---
// Gunakan pengecekan standard 'typeof' yang lebih aman daripada 'globalThis'
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfigRaw = typeof __firebase_config !== 'undefined' ? __firebase_config : null;

let firebaseConfig = null;
let app, db, auth;
let currentUserId = null; 

// --- 2. INISIALISASI FIREBASE ---
try {
    if (firebaseConfigRaw && firebaseConfigRaw.length > 2) {
        firebaseConfig = JSON.parse(firebaseConfigRaw);
    } else {
        // Fallback Configuration Anda (wajib ada untuk testing)
        firebaseConfig = {
            apiKey: "AIzaSyDP7cEwU1u9CWGhGU2F2DwyUhRIoBJigpg",
            authDomain: "menu.originalamanah.com",
            projectId: "menu-12d3c",
            storageBucket: "menu-12d3c.firebasestorage.app",
        };
    }
    
    if (!firebaseConfig || !firebaseConfig.projectId) {
        throw new Error("Konfigurasi Firebase (projectId) tidak ditemukan atau tidak valid.");
    }

    app = initializeApp(firebaseConfig);
    auth = getAuth(app);
    db = getFirestore(app);
    
    // Inisialisasi DOM setelah Firebase siap
    document.addEventListener('DOMContentLoaded', () => {
        const loginButton = document.getElementById('login-button');
        if (loginButton) {
            loginButton.disabled = false;
            loginButton.textContent = 'Masuk';
        }
    });

} catch (error) {
    console.error("Kesalahan Fatal Inisialisasi Firebase:", error);
    // Tampilkan pesan error jika elemen ada
    document.addEventListener('DOMContentLoaded', () => {
        const statusEl = document.getElementById('status-message');
        if (statusEl) {
            statusEl.textContent = "ERROR FATAL: Gagal memuat Firebase. Cek konsol browser. " + error.message;
            statusEl.classList.remove('hidden');
            statusEl.classList.add('bg-red-100', 'border-red-400', 'text-red-800');
        }
    });
}

// --- 3. VARIABEL KONSTANTA & PATH ---
const CORRECT_PASSWORD = "ORIGINALAMANAH";
const MENU_COLLECTION_PATH = `artifacts/${appId}/public/data/menu_items`;


// --- 4. OTENTIKASI (Disatukan dari Skrip Lama) ---

async function attemptFirebaseLogin() {
    if (!auth) return false;
    
    try {
        if (initialAuthToken) {
            // Jika token disediakan oleh Canvas, gunakan ini
            await signInWithCustomToken(auth, initialAuthToken);
            console.log("[FIREBASE LOG] Berhasil login dengan token kustom.");
        } else {
            // Jika tidak, masuk secara anonim (fallback)
            await signInAnonymously(auth);
            console.log("[FIREBASE LOG] Berhasil login anonim ke Firebase.");
        }
        return true;
    } catch (error) {
        console.error("[FIREBASE ERROR] Gagal login Firebase:", error);
        // ... (Logika Error disisakan untuk event listener di bawah)
        return false;
    }
}

// --- 5. FUNGSI LOGIKA (Render & Fetch) ---

function renderMenu(items) {
    const menuList = document.getElementById('menu-list');
    if (!menuList) return;
    
    menuList.innerHTML = ''; 
    
    items.sort((a, b) => (a.order || 999) - (b.order || 999) || a.name.localeCompare(b.name));

    if (items.length === 0) {
        menuList.innerHTML = '<div class="col-span-full text-center text-gray-500 p-8 border border-dashed rounded-lg">Tidak ada data menu ditemukan di Firestore.</div>';
        return;
    }

    items.forEach(item => {
        const card = document.createElement('div');
        card.className = 'menu-item-card';
        card.innerHTML = `
            <a href="${item.url || '#'}" target="_blank" class="flex flex-col flex-grow">
                <div class="flex justify-between items-start mb-1">
                    <h3 class="text-xl font-semibold text-gray-900">${item.name || 'Nama Item'}</h3>
                    <span class="text-lg font-bold ${item.highlightColor || 'text-gray-800'}">${item.price || ''}</span>
                </div>
                <p class="text-sm text-gray-700 mt-2">${item.description || 'Deskripsi belum tersedia.'}</p>
            </a>
        `;
        menuList.appendChild(card);
    });
}

async function createInitialMenuData() {
    if (!db) return;
    const statusMessage = document.getElementById('status-message');

    const dummyData = [
        { name: "Website Standard", price: "200k", description: "Website 5 halaman, desain standard, hosting 1 tahun.", highlightColor: "text-blue-700", order: 1, url: "#" },
        { name: "Website Premium", price: "500k", description: "Website Custom 10 halaman, SEO dasar, gratis logo.", highlightColor: "text-green-700", order: 2, url: "#" },
        { name: "Aplikasi Mobile", price: "1jt", description: "Aplikasi Android/iOS, fitur lengkap, maintenance 3 bulan.", highlightColor: "text-red-700", order: 3, url: "#" },
        { name: "Maintenance Bulanan", price: "100k", description: "Perbaikan bug, update konten rutin.", highlightColor: "text-gray-700", order: 4, url: "#" },
        { name: "Landing Page", price: "150k", description: "Satu halaman promosi, fokus konversi.", highlightColor: "text-purple-700", order: 5, url: "#" },
        { name: "Desain UI/UX", price: "80k", description: "Prototype Figma, panduan desain.", highlightColor: "text-gray-700", order: 6, url: "#" }
    ];

    try {
        const menuRef = collection(db, MENU_COLLECTION_PATH);
        const snapshot = await getDocs(query(menuRef));

        if (snapshot.empty) {
            console.log("[FIREBASE LOG] Koleksi menu kosong, membuat data dummy...");
            
            const batchPromises = dummyData.map(item => {
                // Gunakan doc.id yang sederhana untuk menghindari bug obfuscation
                const docId = `item_${item.order}`; 
                return setDoc(doc(db, MENU_COLLECTION_PATH, docId), item);
            });
            
            await Promise.all(batchPromises);
            console.log(`[FIREBASE LOG] ${dummyData.length} data dummy berhasil dibuat.`);
        } else {
            console.log(`[FIREBASE LOG] Koleksi sudah berisi ${snapshot.size} item. Pembuatan data dummy dilewati.`);
        }
    } catch (e) {
        console.error("[FIREBASE ERROR] Gagal membuat data dummy (Kemungkinan Rules WRITE masih disetel ke 'false'):", e.message);
        if (statusMessage) {
            statusMessage.textContent = "INFO: Data tidak ditemukan. Jika ini percobaan pertama, pastikan Rules WRITE di Firestore diubah SEMENTARA menjadi 'allow write: if request.auth != null;' agar data dummy bisa dibuat otomatis.";
            statusMessage.classList.remove('hidden', 'bg-red-100');
            statusMessage.classList.add('bg-yellow-100', 'border-yellow-400', 'text-yellow-800');
        }
    }
}

function fetchMenuData() {
    const loadingIndicator = document.getElementById('loading-indicator');
    const statusMessage = document.getElementById('status-message');
    const ruleCheckMessage = document.getElementById('rule-check-message');

    if (!db || !auth.currentUser) {
        console.warn("[FIREBASE WARNING] fetchMenuData dipanggil sebelum DB atau User siap.");
        if (loadingIndicator) loadingIndicator.classList.add('hidden');
        return;
    }

    const menuRef = collection(db, MENU_COLLECTION_PATH);
    if (loadingIndicator) loadingIndicator.classList.remove('hidden');
    
    const unsubscribe = onSnapshot(menuRef, (snapshot) => {
        if (loadingIndicator) loadingIndicator.classList.add('hidden');
        
        let items = [];
        
        snapshot.docChanges().forEach((change) => {
            console.log(`[FIRESTORE CHANGE] Tipe: ${change.type}, ID Dokumen: ${change.doc.id}`);
            
            if (change.type === "removed" && ruleCheckMessage) {
                ruleCheckMessage.classList.remove('hidden'); 
            }
        });

        snapshot.forEach(doc => {
            items.push(doc.data());
        });
        
        console.log(`[FIREBASE LOG] Jumlah item yang diambil: ${items.length}`);
        
        renderMenu(items);
        
        if (items.length === 0) {
            createInitialMenuData();
        }

    }, (error) => {
        if (loadingIndicator) loadingIndicator.classList.add('hidden');
        console.error("[FIREBASE ERROR] Gagal mengambil data menu (Akses Ditolak/Network Error):", error);
        
        if (statusMessage) {
            statusMessage.textContent = `Gagal mengambil data menu (Akses Ditolak/Network Error). Pastikan Rules READ disetel ke 'allow read: if request.auth != null;'. Error: ${error.message}`;
            statusMessage.classList.remove('hidden', 'bg-yellow-100', 'border-yellow-400', 'text-yellow-800');
            statusMessage.classList.add('bg-red-100', 'border-red-400', 'text-red-800');
        }
    });
    
    // Untuk menghindari peringatan lint
    return unsubscribe;
}

// --- 6. FUNGSI LOGIKA (Login DOM) ---

async function attemptLogin() {
    const passwordInput = document.getElementById('password-input');
    const loginButton = document.getElementById('login-button');
    const errorMessage = document.getElementById('error-message');
    const loginModal = document.getElementById('login-modal');
    const mainContent = document.getElementById('main-content');
    
    if (!passwordInput || !loginButton || !errorMessage || !loginModal || !mainContent) {
        console.error("DOM Elements missing for login.");
        return;
    }

    const enteredPassword = passwordInput.value;
    if (enteredPassword === CORRECT_PASSWORD) {
        loginButton.disabled = true;
        loginButton.textContent = 'Memproses...';
        
        // Coba Login Firebase (sudah diupdate untuk token kustom/anonim)
        const firebaseLoginSuccess = await attemptFirebaseLogin();

        if (firebaseLoginSuccess) {
            loginModal.style.opacity = 0;
            
            setTimeout(() => {
                loginModal.remove();
                mainContent.classList.remove('hidden'); 
            }, 500); 

        } else {
            loginButton.disabled = false;
            loginButton.textContent = 'Masuk Gagal (Cek Konsol)';
            errorMessage.textContent = "Login lokal berhasil, tapi GAGAL terhubung ke Firebase. Cek konsol dan status provider 'Anonymous'.";
            errorMessage.classList.remove('hidden');
            passwordInput.value = ''; 
        }
    } else {
        errorMessage.textContent = "Kata sandi salah. Coba lagi.";
        errorMessage.classList.remove('hidden');
        passwordInput.value = ''; 
        passwordInput.classList.add('border-red-500');
        
        setTimeout(() => {
            errorMessage.classList.add('hidden');
            passwordInput.classList.remove('border-red-500');
        }, 3000);
    }
}

// --- 7. EVENT LISTENERS & INI HAK CIPTA ---

document.addEventListener('DOMContentLoaded', () => {
    const loginButton = document.getElementById('login-button');
    const passwordInput = document.getElementById('password-input');

    if (loginButton) loginButton.addEventListener('click', attemptLogin);
    
    if (passwordInput) passwordInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            attemptLogin();
        }
    });
});

// Listener status auth Firebase
if (auth) {
    onAuthStateChanged(auth, (user) => {
        if (user) {
            console.log("[FIREBASE LOG] Status Auth: Pengguna terotentikasi. Memulai fetch data.");
            fetchMenuData();
        } else {
            console.log("[FIREBASE LOG] Status Auth: Pengguna belum terotentikasi.");
        }
    });
}

// Proteksi Konten
document.addEventListener('contextmenu', function(e) { e.preventDefault(); });
document.addEventListener('keydown', function(e) {
    if (
        (e.ctrlKey || e.metaKey) && (e.key === 'u' || e.key === 'c') ||
        e.key === 'F12' ||
        ((e.ctrlKey || e.metaKey) && e.shiftKey && (e.key === 'i' || e.key === 'j' || e.key === 'c'))
    ) {
        e.preventDefault();
    }
});
